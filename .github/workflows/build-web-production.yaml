name: Build web for production and push to registry
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        required: true
        description: Version of the release in the format of v1.0.0
jobs:
  build-web-production:
    runs-on: arc-runner-release
    defaults:
      run:
        working-directory: ./web
    steps:
      - uses: actions/checkout@v4
      - run: |
          sudo apt update
          sudo apt install -y unzip
      - id: prep
        run: |
          TAG=${{ github.event.release.tag_name || github.event.inputs.version }}
          echo "BUILD_ID=${TAG#v}" >> $GITHUB_OUTPUT
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install --frozen-lockfile
      - run: bun run build
      - run: rm -rf ./node_modules
      - run: bun install --production --frozen-lockfile
      - run: echo ${{ secrets.REGISTRY_PASSWORD }} | docker login -u admin --password-stdin registry.jimmyding.com
      - run: docker build -t registry.jimmyding.com/web:${{ steps.prep.outputs.BUILD_ID }} . -f ../build/web.dockerfile
      - run: docker push registry.jimmyding.com/web:${{ steps.prep.outputs.BUILD_ID }}
